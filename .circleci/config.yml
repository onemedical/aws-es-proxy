version: 2.1
orbs:
  aws-cli: circleci/aws-cli@1.3.2
  aws-ecr: circleci/aws-ecr@8.1.2

commands:

  create_image_tag:
    description: Create image tag based on the current branch
    steps:
      - run:
          name: Create IMAGE_TAG env var based on the current branch
          command: |
            if [[ -n "${CIRCLE_TAG:-}" ]]; then
              image_tag=${CIRCLE_TAG}
            elif [[ $CIRCLE_BRANCH = "master" || $CIRCLE_BRANCH = "staging" ]]; then
              image_tag=${CIRCLE_BRANCH}-${CIRCLE_SHA1}
            else
              image_tag=branch-$(echo $CIRCLE_BRANCH | tr / -)
            fi
            echo "export IMAGE_TAG='${image_tag}'" >> $BASH_ENV

jobs:
  release:
    machine:
      docker_layer_caching: true
    steps:
      - aws-cli/install
      - checkout
      - create_image_tag
      - aws-ecr/build-and-push-image:
          dockerfile: Dockerfile
          region: AWS_DEFAULT_REGION
          repo: onemedical/aws-es-proxy
          tag: ${IMAGE_TAG}

workflows:
  version: 2
  everything:
    jobs:
      - release:
          filters:
            tags:
              only: /^v\d+\.\d+\.\d+/
